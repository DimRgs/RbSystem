<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="system.mapper.UserMapper">
	<resultMap type="User" id="user_map">
		<id property="id" column="id" />
		<result property="password" column="password" />
		<result property="name" column="name" />
		<result property="idcard" column="id_card" />
		<result property="telephone" column="telephone" />
		<result property="register_date" column="register_time" />
		<result property="gender" column="gender" />
	</resultMap>
	<resultMap type="RbDetail" id="rb_map">
		<id property="id" column="id" />
		<result property="state" column="rb_state_id" />
		<result property="hospital" column="hospital" />
		<result property="date" column="s_time" />
		<association property="user" javaType="User">
			<id property="id" column="id" />
		</association>
	</resultMap>
	<resultMap type="UserInfo" id="userInfo_map">
		<association property="user" javaType="User">
			<id property="id" column="id" />
			<result property="password" column="password" />
			<result property="name" column="name" />
			<result property="idCard" column="id_card" />
			<result property="telephone" column="telephone" />
			<result property="register_date" column="register_time" />
			<result property="gender" column="gender" />
			<result property="type" column="type" />
		</association>
		<association property="department" javaType="Department">
			<id property="id" column="d_id" />
			<result property="name" column="d_name" />
		</association>
	</resultMap>
	<!-- insert -->
	<insert id="insertNewRb">
		insert into rb_detail
		(id, user_id, rb_state_id)
		values ('${param1}', '${param2}', 1)
	</insert>
	<!-- select -->
	<select id="getLastRb" resultType="rb_map">
		select rb_detail.id, rb_detail.rb_state_id
		from rb_detail, user 
		where `user`.id = rb_detail.user_id 
		order by rb_detail.s_time desc 
		limit 1
	</select>
	<select id="getDepartmentCount" resultType="int">
		select count(*) from department
	</select>
	<select id="getUserById" resultMap="user_map">
		select * from department 
		where id = '${param1}' and password = '${param2}' 
	</select>
	<select id="getUserInfo" resultMap="userInfo_map">
		select 
			department.id as d_id, 
			department.name as d_name, 
			user.* ,user_type.*
		from 
			user, department, user_type
		where 
			user.department_id = department.id and
			user.id = '${param1}' and 
			user.password = '${param2}' and 
			user.user_type_id = user_type.id
	</select>
	<!-- update -->
	<update id="updateUserTel">
		update user set telephone = '${param2}'
		where id ='${param1}'
	</update>
	<update id="updateUserPsd">
		update user set password = '${param3}'
		where id = '${param1}'
		and password = '${param2}'
	</update>
</mapper>